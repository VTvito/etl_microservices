services:
  airflow:
    build:
      context: ./airflow
      dockerfile: Dockerfile
    container_name: airflow
    volumes:
      - etl-data:/app/data  # Volume condiviso per i dati
      - etl-data-dags:/opt/airflow/dags  # Volume per la cartella dei DAGs
      # per montare una cartella locale direttamente
      # - ./local_dags_folder:/opt/airflow/dags
    ports:
      - "8080:8080"
    networks:
      - etl-network
    restart: always

# monitoraggio microservizi
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - etl-network
    restart: always

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - etl-network
    restart: always


  read-csv-service:
    build:
      context: ./read-csv-service
      dockerfile: Dockerfile
    container_name: read-csv-service
    volumes:
      - etl-data:/app/data  # Shared volume
    expose:
      - "5001"
    ports:
      - "5001:5001"
    networks:
      - etl-network
    restart: always

  clean-nan-csv-service:
    build:
      context: ./clean-nan-csv-service
      dockerfile: Dockerfile
    container_name: clean-nan-csv-service
    volumes:
      - etl-data:/app/data  # Shared volume
    expose:
      - "5002"
    ports:
      - "5002:5002"
    networks:
      - etl-network
    restart: always

  get-columns-csv-service:
    build:
      context: ./get-columns-csv-service
      dockerfile: Dockerfile
    container_name: get-columns-csv-service
    volumes:
      - etl-data:/app/data  # Shared volume
    expose:
      - "5003"
    ports:
      - "5003:5003"
    networks:
      - etl-network
    restart: always

  delete-columns-csv-service:
    build:
      context: ./delete-columns-csv-service
      dockerfile: Dockerfile
    container_name: delete-columns-csv-service
    volumes:
      - etl-data:/app/data  # Shared volume
    expose:
      - "5004"
    ports:
      - "5004:5004"
    networks:
      - etl-network
    restart: always  

networks:
  etl-network:
    driver: bridge

volumes:
  etl-data:
  etl-data-dags:
  grafana-data: